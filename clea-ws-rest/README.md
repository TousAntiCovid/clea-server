## Clea Ws Rest

Exposed [REST APIs](https://gitlab.inria.fr/stopcovid19/clea-server/-/blob/develop/clea-ws-rest/src/main/resources/openapi-clea-server-v1.yml) for reporting 1..\* visits.

### Validity verifications:

When a report is sent, the following verifications are applied to the request:

- if any field does not respect its type, all the request is
  rejected
- Individual visits that are not valid, will be pruned from the
  request, while other valid visits will be kept.

### Reporting verifications:

Pivot Date must be between the retention date (today minus 14 days by default) and today, or else it will be set to the retention Date.

After the validity of the report is checked, all visits are decoded, and the following verifications are applied:

- if there's an error while decoding a specific visit, it will be individually purged (decoding=extract the different fields without decryption).
- if a visit has its scan time before the retention date, it will be considered as outdated and rejected individually.
- if a visit has its scan time after today, it will be considered in future and rejected individually.
- Multiple visits to the same location (based on temporary id) will be considered duplicates, if their qr scan time
  is withing the configured duplicate scan threshold (half an hour by example). Only 1 is kept.

### Publishing reports:

After all verifications are applied, the decoded visits are sent to a kafka queue, to be processed by the next chain.

### Data Models:

When a user scan an image (qrcode), the mobile application receives an URL with this form:
[https://tac.gouv.fr?v=0#AK4e..u6k]("https://tac.gouv.fr?v=0#AK4ebl4J7VLSQh5hCBQaim7yghhwBGoW8bVgg3iNYKcPwDMFgnFo_DVChp5KZAqyoI85nwMtt5iSLhYp9EM1JZvBP1FmnoPbxSiKyCADPP63hs4_Qa1YbzvcVoe8fU8L3G8nFQvlfOx3XJ3fu6k")

The anchor part (AK...u6k) is stored on the phone with the scan date. This part is also called LocationSpecificPart.

When a user declares himself positive, he completes the date of the first symptom or the date of his positive test.
the mobile application determines a pivot date of contagiousness.

The structure received by this module is:

- pivotDateAsNtpTimestamp : pivotDate as NTP Timestamp. It pivot date is less than now - property clea.conf.retentionDurationInDays days, then
  the pivot date used to detect backward or forward visits will be (now - property clea.conf.retentionDurationInDays days)
- An array of visits composed of:

  . qrCodeScanTime : date of scan as NTP Timestamp
  . qrCode: a LocationSpecificPart

When a LocationSpecificPart is decoded (not decrypted) the new structure is:

LocationSpecificPart:

- version: (=0) for future uses
- type: (=0/1) : synchronous/asynchronous scan. Controls on dates only manage synchronous (0) scans.
- locationTemporaryPublicId: a UUID representing a location
- encryptedLocationMessage: a binary structure that needs a private key to be decrypted.

The data model pushed to Kafka is:

- qrCodeScanTime: scan date as NTP Timestamp
- isBackward: boolean, true if qrCodeScanTime < pivotDate
- version: 0
- type: 0
- locationTemporaryPublicId: UUID as string
- encryptedLocationMessage: array of bytes

### Statistiques

This module a row of statistics for each report to a dedicated Kafka topic.

the data model used for each report is:

- timestamp (long): time the report was received as an NTP Timestamp.
- reported (int): number of visits reported in the report
- rejected (int): the causes of the rejections are:
  - outdate : number of days between now and visit.qrCodeScanTime > property clea.conf.retentionDurationInDays (14 days by default)
  - future: visit.qrCodeScanTime > now.
  - duplicated scan: For the same LocationId, a second scan take place before property clea.conf.duplicateScanThresholdInSeconds (1800 sec/ 30 minutes)
- backwards (int): visit.qrCodeScanTime < pivotDate
- forwards (int): visit.qrCodeScanTime >= pivotDate
- close (int): count of non-rejected visits, those with a different locationTemporaryPublicId and a scan date interval less than the duration of a slot (property clea.conf.exposureTimeUnitInSeconds 1800sec/30 min by default)

### Security

In production, this module expects to receive a valid JWT token generated by the Robert-Server component.
The mobile application authenticates against Robert server by doing a "/status" call which returns a token used to report positivity to Robert server.
The same token can be used to report to Clea.

### Build

This module is part of Clea-server project.

Build clea-server project to build all the modules.

### Run

This module is an uber-jar. You can use this command to execute it:

```bash
java -jar target/clea-ws-rest*-exec.jar
```

This module can be executed by maven:

```bash
$ docker build -t tac/clea-ws-rest:latest .
$ docker run -it --rm --name clea-ws-rest -p 8080:8080 clea-ws-rest:latest  --spring.profiles.active=dev,docker
```

the docker-compose.yml at the root of clea-server execute this service

```bash
$ docker-compose up
#or
$ docker-compose up clea-ws-rest
```

Display the Clea API and use it: http://localhost:8080/swagger-ui/

Display the Clea OpenAPI generated from the code: http://localhost:8080/v3/api-docs?group=clea

### Dependencies

This module can start standalone but requires a running Kafka cluster to function.
The property "spring.kafka.bootstrap-servers" must point to a kafka server.
