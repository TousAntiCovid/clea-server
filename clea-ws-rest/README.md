## Clea Ws Rest

Exposed [REST APIs]("src/main/resources/openapi-clea-server-v1.yml") for reporting 1..\* visits.

### Validity verifications:

When a report is sent, the following verifications are applied to the request:

- if any field does not respect its type, all the [request]("src/main/java/fr/gouv/clea/ws/vo/ReportRequest.java") is
  rejected
- Individual [visits]("src/main/java/fr/gouv/clea/ws/vo/Visit.java") that are not valid, will be pruned from the
  request, while other valid visits will be kept.

### Reporting verifications:

Pivot Date must be contained between the retention date (today minus 14 days by default) and today, if not it will be set to the retention Date.

After the validity of the report is checked, all visits are decoded, and the following verifications are applied:

- if there's an error while decoding a specific visit, it will be individually purged (decoding=extract the different fields without decryption).
- if a visit has its scan time before the retention date, it will be considered as outdated and rejected individually.
- if a visit has its scan time after today, it will be considered in future and rejected individually.
- Multiple visits to the same location (based on temporary id) will be considered duplicates, if their qr scan time
  is withing the configured duplicate scan threshold (half an hour by example). Only 1 is kept.

### Publishing reports:

After all verifications are applied, the decoded visits are sent to a kafka queue, to be processed by the next chain.

### Data Models:

When a user scan an image (qrcode), the mobile application receives an URL with this form:
[https://tac.gouv.fr?v=0#AK4e..u6k]("https://tac.gouv.fr?v=0#AK4ebl4J7VLSQh5hCBQaim7yghhwBGoW8bVgg3iNYKcPwDMFgnFo_DVChp5KZAqyoI85nwMtt5iSLhYp9EM1JZvBP1FmnoPbxSiKyCADPP63hs4_Qa1YbzvcVoe8fU8L3G8nFQvlfOx3XJ3fu6k")

The anchor part (AK...u6k) is stored on phone with the date of the scan. This part is also called LocationSpecificPart.

When a user declares himself positive, he completes the date of the first symptom or the date of his positive test.
the mobile application determines a pivotal date of contagiousness

The structure received by this module is :

- pivotDateAsNtpTimestamp : pivotDate as NTP Timestamp
- An array of visits composed of:

  . qrCodeScanTime : date of scan as NTP Timestamp
  . qrCode: each LocationSpecificPart

When each LocationSpecificPart is decoded (not decrypted) the new structure is:

LocationSpecificPart:

- version: (=0) for future uses
- type: (=0/1) : synchronous/asynchronous scan. Contr√¥les on dates only manage synchronous (0) scans.
- locationTemporaryPublicId: a UUID representing a location
- encryptedLocationMessage: a binary structure that need a private key to be decrypted.

The data model pushed to Kafka is :

- qrCodeScanTime: date of scan as NTP Timestamp
- isBackward: boolean, true if qrCodeScanTime < pivotDate
- version: 0
- type: 0
- locationTemporaryPublicId: UUID as string
- encryptedLocationMessage: as array of bytes

### Security

In production, this module expects to receive a valid JWT token generated by the Robert-Server component.
The mobile application authenticates against Robert by doing a "/status", receives a token used to report positivity to Robert server.
The same token could be used to report to Clea.

### Build

This module is part of Clea-server project.

Build clea-server project to build all the modules.

### Run

This module is an uber-jar. You can use this command to execute it:

```bash
java -jar target/clea-ws-rest*-exec.jar --spring.profiles.active=dev
```

This module can be executed by maven:

```bash
mvn spring-boot:run -Dspring-boot.run.arguments=--spring.profiles.active=dev
```

This application can be packaged as Container image then executed :

```bash
$ docker build -t tac/clea-ws-rest:latest .
$ docker run -it --rm --name clea-ws-rest -p 8080:8080 clea-ws-rest:latest  --spring.profiles.active=dev,docker
```

Display the Clea API and use it: http://localhost:8080/swagger-ui/

Display the Clea OpenAPI generated from the code: http://localhost:8080/v3/api-docs?group=clea

### Dependencies

This module can start standalone but requires a running Kafka cluster to function.
The property "spring.kafka.bootstrap-servers" must point to a kafka server.
